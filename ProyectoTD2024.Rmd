---
title: "Proyecto TD 2024"
author: "Grupo C"
date: "2024-03-26"
output: html_document
---

**INTRODUCCIÓN**

El comercio minorista ha experimentado una transformación significativa en las 
últimas décadas, con la digitalización y la adopción de nuevas tecnologías que 
han impactado en la forma en que los consumidores realizan sus compras. En este 
contexto, la disponibilidad de datos detallados sobre las transacciones de 
compra se ha convertido en un activo invaluable para las empresas minoristas, 
permitiéndoles comprender mejor el comportamiento del cliente, optimizar la 
gestión de inventario y desarrollar estrategias de marketing más efectivas.

En este sentido, Mercadona, una de las cadenas de supermercados más grandes y 
reconocidas en España, se encuentra en una posición privilegiada para aprovechar
los datos generados por las transacciones de sus clientes. Con una amplia red de
tiendas y una amplia variedad de productos, Mercadona está constantemente 
buscando formas de mejorar su oferta y satisfacer las necesidades cambiantes de 
sus clientes.

En línea con esta visión, el presente estudio se centra en el análisis de los 
tickets de compra obtenidos en Mercadona, con el objetivo de extraer información
valiosa sobre los patrones de compra, preferencias de productos, tendencias de 
gasto y otros aspectos relevantes relacionados con la experiencia del cliente. 
Al analizar estos datos de manera sistemática, podemos obtener una visión más 
clara y detallada de los hábitos de compra de los clientes, lo que a su vez 
puede informar decisiones estratégicas importantes para Mercadona.

Este informe se estructura en torno a una serie de preguntas de análisis 
específicas, que abarcan desde la relación entre las compras individuales hasta 
el análisis de tendencias a nivel agregado. A través de un enfoque riguroso de
procesamiento de datos y análisis estadístico, buscamos proporcionar información
relevante y perspicaz que pueda ser utilizada por Mercadona para mejorar la 
eficiencia operativa, optimizar la gestión de inventario y mejorar la experiencia
general del cliente.

**DESCRIPCIÓN DE DATOS**
La descripción de los datos revela la naturaleza rica y variada de la información
recopilada de los tickets de compra de Mercadona.


**PROYECTO TD 2024**

Primero, vamos a empezar introduciendo todos los datos que queremos tratar:
Entonces, el usuario al ir a comprar en Mercadona, tiene que pedir que le envien
los tickets por el correo electrónico en lugar de recibirlos en papel. En ese 
momento, los usuarios tendrían que poder ver los tickets perfectamente en pdf.
Podemos observar que tenemos una carpeta 'data' en la que se encuentran 
diferentes tickets.
El objetivo que tenemos nosotros es analizarlos para realizar un seguimiento de 
todo lo que se indica en esos tickets. La información que podemos encontrar en 
los tickets es: evolución de dinero (en caso de que se pague en efectivo), 
cuáles son los productos que la gente más compra, que mercadona es el que la 
gente va mas a comprar, en que hora se suele ir mas a comprar...

Una vez descrito nuestro objetivo, tenemos que importar los datos de la carpeta
data, que ya ha sido nombrada anteriormente, para el análisis.

Vamos a establecer la instalación automática de los paquetes:
```{r, message=FALSE} 
#(package manager) para gestionar la instalación de librerías. 
#message=FALSE no sale cuando se compila
# Asegúrate que el paquete "pacman" está instalado
if (!require("pacman")) install.packages("pacman")

#Utilizamos la función `p_load` para la carga e instalación de paquetes
p_load(ggplot2, knitr, tidyverse,stringr,lubridate)
```

Ahora queremos leer todos los ficheros que encontramos en la carpeta data, que 
como sabemos son todos los tickets de Mercadona que hemos ido consiguiendo.
Entonces, ahora queremos ir leyendo todos los ficheros(tickets) que 
contengan o que esten guardados con la extensión .txt.

```{r}
#Archivos .txt de la carpeta 'data':
#Para ello hacemos uso de la función list.files()
#Estableceremos la carpeta y el patrón buscado
#para leer dichos ficheros (txt):
#full.names para ruta completa de archivos.
list_tickets <- list.files("data", pattern = "\\.txt$", full.names = TRUE)

cifrado <- guess_encoding(list_tickets[1])

cifrado_ticket <- cifrado[1,1]
#Leemos ahora el contenido de uno:
ticket1 <- readLines(list_tickets[1], encoding = as.character(cifrado_ticket))

categorias <- c("Pescado","Frutas_Verduras")

ticket1 <- as.data.frame(ticket1)

len_ticket1 <- as.numeric(nrow(ticket1))

supermercado <- ticket1[1,]
direccion <- ticket1[2,]
codigo_postal_ciudad <- ticket1[3,]
telefono <- ticket1[4,]
fecha_hora_operador <- ticket1[5,]
factura <- ticket1[6,]
productos <- ticket1[c(8:(len_ticket1-14)),]
total <- ticket1[len_ticket1-13,]
metodo_pago <- ticket1[len_ticket1-12,]
N.C <- ticket1[len_ticket1-4,]
importe <- ticket1[len_ticket1-1,]

ticket1.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                           telefono,fecha_hora_operador,factura,
                           productos,total,metodo_pago,N.C,
                           importe)

```

Hasta ahora hemos leido solo las lineas que contienen los tickets, y con estas 
estructuras hemos podido crear un dataframe.

Podemos ver, como las 7 primeras líneas y las últimas 13 siempre siguen la misma
estructura, porque es el metodo de pago, el importe final, la ubicación del
Mercadona, ...

Por tanto, las diferencias de los tickets siempre dependen de los productos y 
la cantidad de productos que se compran.

Vamos a sacar un análisis mucho más detallado.


```{r}
len_ticket1.tidy <- as.numeric(nrow(ticket1.tidy))

numero_telefono <- gsub("TELÉFONO: ", "",ticket1.tidy$telefono)
ticket1.tidy$telefono <- numero_telefono

cantidades_prod <- ticket1.tidy$productos
cantidades <- str_extract(cantidades_prod, "^\\d+")
ticket1.tidy <- cbind(ticket1.tidy, Cantidades = cantidades)

productos_sin_cantidad <- gsub("^\\d+\\s*", "", ticket1.tidy$productos)
ticket1.tidy$productos <- productos_sin_cantidad

nombres_productos_sin_kg <- gsub("[Kk][Gg]\\s*", "", ticket1.tidy$productos)
ticket1.tidy$productos <- nombres_productos_sin_kg

precios <- gsub(".*\\s(\\d+[,.]\\d+)$", "\\1", ticket1.tidy$productos)
ticket1.tidy <- cbind(ticket1.tidy, Precios = precios)

nombres_productos <- gsub("[^[:alpha:] ]", "", ticket1.tidy$productos)
ticket1.tidy$productos <- nombres_productos

id_factura <- gsub("[^0-9]", "", ticket1.tidy$factura)
ticket1.tidy$factura <- id_factura

fecha <- gsub("^(\\d{2}/\\d{2}/\\d{4}).*$", "\\1",ticket1.tidy$fecha_hora_operador)
ticket1.tidy <- cbind(ticket1.tidy,Fecha = fecha)

hora <- gsub("^.*\\b(\\d{2}:\\d{2}).*$", "\\1",ticket1.tidy$fecha_hora_operador)
ticket1.tidy <- cbind(ticket1.tidy, Hora = hora)

ticket1.tidy <- subset(ticket1.tidy, select = -fecha_hora_operador)
ticket1.tidy <- subset(ticket1.tidy, select = -total)

metodo_pago <- gsub("[^[:alpha:] ]", "", ticket1.tidy$metodo_pago)
ticket1.tidy$metodo_pago <- metodo_pago

importe <- gsub(".*\\b(\\d+[,.]\\d+).*$", "\\1", ticket1.tidy$importe)
ticket1.tidy$importe <- importe

ticket1.tidy <- separate(ticket1.tidy, codigo_postal_ciudad,c("codigo postal",
                                                              "ciudad"), 
                         sep = " ")

N.C <-gsub("^N.C: (\\d+).*", "\\1", ticket1.tidy$N.C)
ticket1.tidy$N.C <- N.C

ticket1.tidy$Fecha <- dmy(ticket1.tidy$Fecha)

ticket1.tidy$Hora <- hm(ticket1.tidy$Hora)
```

Tenemos que analizar cada línea de los tickets, porque cada línea y cada signo
que hay en los tickets se tiene que interpretar de una manera diferente. Porque 
por ejemplo, como veremos abajo explicado, no podemos considerar igual la fila de
la dirección, fecha, hora de la compra, ... que la cantidad comprada de un producto determinado.

Para cada una de las columnas de nuestro data frame en bruto, aplicamos una serie de condiciones que nos permitirán "limpiar" los elementos no interesantes de nuestro análisis.

Por ejemplo, si algunos productos tienen la cantidad adquirida delante, sabemos que el número delante del str será la cantidad adquirida y podemos almacenarla en otra columna, a la vez que la borramos de la variable de productos.

Otro ejemplo es con la fecha y la hora.
Al leerla en una linea nos queda un formato de esta manera: "d/m/Y XX:XX".
Si queremos almacenarlas en variables diferentes, podemos poner una condicion de que los elementos de la columna fecha tengan esta estructura "d/m/Y" y los elementos que tengan estructura tipo "XX:XX" los podemos almacenar en otra variable.

Es muy importante ver si hay valores faltantes o NA, o valores que en general no 
tienen demasiado sentido. Entonces, lo que habrá que hacer es:
Se debería hacer una comprobación para ver si hay alguna observación con valores faltantes para su posterior depuración, ya sea eliminando esa observación, o imputando otro tipo de dato según una serie de criterios.

Con todos estos cambios hechos, y con todas las líneas que podemos encontrar en
un ticket de Mercadona, ya tendremos un data frame bien pulido, y en teoria, si 
está hecho de forma eficiente, tendríamos que sacar toda la información sobre nuestra
compra en este data frame.


Ahora expondremos una tabla para poder ver el resultado de nuestro data frame.


```{r}
variables <- c("Supermercado","Direccion","Codigo Postal","Ciudad","Telefono",
               "Factura","Productos","Metodo de Pago","Número de Cliente",
               "Cantidad","Precio","Importe","Fecha","Hora")

descripcion <- c("Id del supermercado","Dirección",
                 "Código Postal del supermercado","Ciudad",
                 "Telefono del supermercado","Número de factura",
                 "Productos adquiridos","Método de Pago","Id del cliente",
                 "Cantidad de productos","Precio del producto","Importe final"
                 ,"Fecha de la compra",
                 "Hora de la compra")

elemento <- c("MERCADONA, S.A A-46103834","C/ MENORCA (C.C. AQUA) 19","46023",
              "Valencia","963319378","3075010680549","PATATA",
              "TARJETA BANCARIA","077763746","1","6,49","60,47","2023/12/18",
              "18H 56M 0S")

tabla <- data.frame(variables,descripcion,elemento)

kable(tabla,caption = "Ejemplo de Muestra",booktabs = TRUE, label ="tab:tabla")
```

Con esta tabla, podemos observar claramente cada variable de interés para nuestro posterior análisis.

**PREGUNTAS PLANTEADAS CARA AL ANÁLISIS**

1. ¿Hay relación entre dos compras aleatorias en nuestra carpeta?

2. ¿Cuál es el promedio de gasto de los tickets?

3. ¿Producto más comprado en general?

4. ¿En qué Mercadona se ha comprado más?

5. ¿Cuál es la media de dinero que se gasta la gente cada vez que va a comprar y le dan un ticket?

6. ¿Cuál es la franja horaria más habitual en que se han producido los tickets registrados?

7. ¿Cuál es la categoría más comúnmente comprada en cada ticket?

8. ¿Existe alguna relación entre la cantidad de productos de la compra y la hora a la que se ha hecho?

9. ¿Existe alguna correlación entre el tipo de producto comprado y la hora a la que se ha hecho la compra?




