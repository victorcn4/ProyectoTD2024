---
title: "DEPURACIÓN TICKETS"
author: "GRUPO C"
date: "2024-04-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE} 
#(package manager) para gestionar la instalación de librerías. 
#message=FALSE no sale cuando se compila
# Asegúrate que el paquete "pacman" está instalado
if (!require("pacman")) install.packages("pacman")

#Utilizamos la función `p_load` para la carga e instalación de paquetes
p_load(ggplot2, knitr, tidyverse,stringr,lubridate, png , reticulate)

rm(list = ls())
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
list_tickets <- list.files("data", pattern = "\\.txt$", full.names = TRUE)

ticket <- readLines(list_tickets[1])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}

ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
  ticket1.tidy <- data.frame( supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)
  
```

```{r}
  
ticket <- readLines(list_tickets[2])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket2.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)
  
ticket <- readLines(list_tickets[3])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket3.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[4])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket4.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[5])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket5.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[6])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket6.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[7])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket7.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[8])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket8.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[9])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket9.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[10])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket10.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[11])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket11.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos, 
                             importe_total)

ticket <- readLines(list_tickets[12])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket12.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[13])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket13.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[14])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket14.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[15])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket15.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[16])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]
  
ticket16.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[17])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]

ticket17.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                             telefono, fecha_hora_operador, factura, productos,
                             importe_total)

ticket <- readLines(list_tickets[18])

for (i in ticket){
  
  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ", "N", ticket)

}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]

ticket18.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                            telefono, fecha_hora_operador, factura, productos,
                            importe_total)

ticket <- readLines(list_tickets[19])

for (i in ticket){
  
  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N", ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]

ticket19.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                            telefono, fecha_hora_operador, factura, productos,
                            importe_total)

ticket <- readLines(list_tickets[20])

for (i in ticket){
  
  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ", "N", ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe_total <- ticket[len_ticket-1,]

ticket20.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad, 
                            telefono, fecha_hora_operador, factura, productos,
                            importe_total)

```

```{r}
todos_productos <- c(ticket1.tidy$productos, ticket2.tidy$productos,
                     ticket3.tidy$productos,ticket4.tidy$productos,
                     ticket5.tidy$productos,ticket6.tidy$productos,
                     ticket7.tidy$productos,ticket8.tidy$productos,
                     ticket9.tidy$productos,ticket10.tidy$productos,
                     ticket11.tidy$productos,ticket12.tidy$productos,
                     ticket13.tidy$productos,ticket14.tidy$productos,
                     ticket15.tidy$productos,ticket16.tidy$productos,
                     ticket17.tidy$productos,ticket18.tidy$productos,
                     ticket19.tidy$productos,ticket20.tidy$productos)

todos_productos2 <- todos_productos
todos_productos <- data.frame(todos_productos,todos_productos2)
```

```{r}
todos_productos$todos_productos <- gsub("[[:digit:]]","",todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("[[:punct:]]","",todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("ENTRADA$|ENTRADA[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("SALIDA|SALIDA[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("PARKING$|PARKING[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("TOTAL$|TOTAL[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("Importe$|Importe[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("P Unit$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("Descripcin$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("IVA$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("BASE IMP",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("CUOTA$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("VISA",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("NC$|NC[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("AID A",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("kg",NA,todos_productos$todos_productos)
View(todos_productos)

todos_productos$todos_productos <- gsub("BANCARIA$|BANCARIA[ ]+$",NA,todos_productos$todos_productos)
View(todos_productos)

productos_dep <- unique(todos_productos$todos_productos)
```

```{r}
todas_fech_horas
```


```{r}
Cat_prod <- c("Frutas_Verduras","Hogar","Carnes","Drogueria","Lácteos","Congelados","Enlatados",
              "Pasta","Bebidas","Aceite")

fv <- grep("PATATA",productos_dep)
fv2 <- grep("TOMATE",productos_dep)
fv3 <- grep("PLATANO",productos_dep)
fv4 <- grep("MANZANA",productos_dep)

```


```{r}
ticket1.tidy$telefono <- gsub("TELFONO: ", "",ticket1.tidy$telefono)


ticket1.tidy$fecha_hora_operador <- gsub("  OP: [123456789]*","",ticket1.tidy$fecha_hora_operador)

ticket1.tidy <- ticket1.tidy |> separate(col = fecha_hora_operador, 
                                         into = c("Fecha","Hora"),sep = " ")

ticket1.tidy$Fecha <- dmy(ticket1.tidy$Fecha)

ticket1.tidy$Hora <- hm(ticket1.tidy$Hora)

ticket1.tidy$importe_total <- gsub("[[:alpha:]]", "", ticket1.tidy$importe_total)

ticket1.tidy$importe_total <- gsub(" ", "", ticket1.tidy$importe_total)

ticket1.tidy$importe_total <- gsub(",",".", ticket1.tidy$importe_total)

ticket1.tidy$importe_total <- gsub(":","",ticket1.tidy$importe_total)

ticket1.tidy$telefono <- gsub("TELFONO: ", "",ticket1.tidy$telefono)


ticket2.tidy$fecha_hora_operador <- gsub("  OP: [123456789]*","",ticket2.tidy$fecha_hora_operador)

ticket2.tidy <- ticket1.tidy |> separate(col = fecha_hora_operador, 
                                         into = c("Fecha","Hora"),sep = " ")

ticket2.tidy$Fecha <- dmy(ticket2.tidy$Fecha)

ticket2.tidy$Hora <- hm(ticket2.tidy$Hora)

ticket2.tidy$importe_total <- gsub("[[:alpha:]]", "", ticket2.tidy$importe_total)

ticket2.tidy$importe_total <- gsub(" ", "", ticket2.tidy$importe_total)

ticket2.tidy$importe_total <- gsub(",",".", ticket2.tidy$importe_total)

ticket2.tidy$importe_total <- gsub(":","",ticket2.tidy$importe_total)
```


