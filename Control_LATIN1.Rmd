---
title: "DEPURACIÓN TICKETS"
author: "GRUPO C"
date: "2024-04-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, message=FALSE} 
#(package manager) para gestionar la instalación de librerías. 
#message=FALSE no sale cuando se compila
# Asegúrate que el paquete "pacman" está instalado
if (!require("pacman")) install.packages("pacman")

#Utilizamos la función `p_load` para la carga e instalación de paquetes
p_load(ggplot2, knitr, tidyverse,stringr,lubridate, png , reticulate)

rm(list = ls())
```

```{r,echo=FALSE,warning=FALSE,message=FALSE}
list_tickets <- list.files("data", pattern = "\\.txt$", full.names = TRUE)

ticket <- readLines(list_tickets[1])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}

ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
  ticket1.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)
  
ticket <- readLines(list_tickets[2])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket2.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)
  
ticket <- readLines(list_tickets[3])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket3.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[4])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket4.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[5])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket5.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[6])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket6.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[7])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket7.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)
ticket <- readLines(list_tickets[8])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket8.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[9])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket9.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[10])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket10.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[11])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket11.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[12])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket12.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[13])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket13.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[14])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket14.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[15])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket15.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[16])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket16.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[17])

for (i in ticket){

  ticket <- iconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N",ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]
  
ticket17.tidy <- data.frame(supermercado,direccion,codigo_postal_ciudad,
                             telefono,fecha_hora_operador,factura,
                             productos,importe)

ticket <- readLines(list_tickets[18])

for (i in ticket){
  
  ticket <- inconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ", "N", ticket)

}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]

ticket18.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                            telefono, fecha_hora_operador, factura, productos,
                            importe)

ticket <- readLines(list_tickets[19])

for (i in ticket){
  
  ticket <- inconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ","N", ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]

ticket19.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad,
                            telefono, fecha_hora_operador, factura, productos,
                            importe)

ticket <- readLines(list_tickets[20])

for (i in ticket){
  
  ticket <- inconv(ticket, "latin1", "ASCII", sub = "")
  ticket <- gsub("Ñ", "N", ticket)
  
}
ticket <- as.data.frame(ticket)
len_ticket <- as.numeric(nrow(ticket))
supermercado <- ticket[1,]
direccion <- ticket[2,]
codigo_postal_ciudad <- ticket[3,]
telefono <- ticket[4,]
fecha_hora_operador <- ticket[5,]
factura <- ticket[6,]
productos <- ticket[c(8:(len_ticket-14)),]
importe <- ticket[len_ticket-1,]

ticket20.tidy <- data.frame(supermercado, direccion, codigo_postal_ciudad, 
                            telefono, fecha_hora_operador, factura, productos,
                            importe)

```

```{r}
numero_telefono <- gsub("TELFONO: ", "",ticket1.tidy$telefono)
ticket1.tidy$telefono <- numero_telefono

fecha <- gsub("  OP: [123456789]*","",ticket1.tidy$fecha_hora_operador)
ticket1.tidy$fecha_hora_operador <- fecha

ticket1.tidy$fecha_hora_operador <- dmy_hm(ticket1.tidy$fecha_hora_operador)

importe <- gsub("[[:alpha:]]", " ", ticket1.tidy$importe)
ticket1.tidy$importe <-importe

importe <- gsub("[[:space]]", "", ticket1.tidy$importe)
ticket1.tidy$importe <- importe

importe <- gsub(",",".", ticket1.tidy$importe)
ticket1.tidy$importe <- importe


```


